<!DOCTYPE html>
<html>
<meta charset="utf-8" />
<title>WebSocket Test</title>
<body>
<style>
  marquee.player_info { width:400px; }
  #irc { overflow:auto; min-width:400px; }
  #player { float:left; }
  #output { clear:both; }
  #irc-client { border:0; width:100%; height:480px; }
  #loginForm { display: inline; }
  #loginForm label { display: inline; }
  #loginForm input { display: inline; }
</style>
<script language="javascript" type="text/javascript">
  var player;
  var userCred;
  var reconnectLoop;

  // Websocket control
  var wsUri = "ws://localhost:8090/";
  var output;
  function init() {
    output = document.getElementById("output");
    document.getElementById("loginForm").addEventListener('submit', processLogin);
    testWebSocket();
  }
  function testWebSocket() {
    websocket = new WebSocket(wsUri);
    websocket.onopen = onOpen;
    websocket.onclose = onClose;
    websocket.onmessage = onMessage;
    websocket.onerror = onError;
    if(reconnectLoop) clearInterval(reconnectLoop);
  }
  function onOpen(evt) {
    writeToScreen("CONNECTED");
  }
  function onClose(evt) {
    writeToScreen("DISCONNECTED");
    reconnectLoop = setInterval(testWebSocket, 1000 + Math.random() * 1000);
    //testWebSocket();
  }
  function onMessage(evt) {
    writeToScreen('<span style="color: blue;">RESPONSE: ' + evt.data+'</span>');
    var obj = JSON.parse(evt.data);
    switch(obj.cmd) {
      case 'PLAY':
        playTrack(obj.srcId, obj.trackId, obj.time, obj.meta);
        break;
      default:
        break;
    }

  }
  function onError(evt) { writeToScreen('<span style="color: red;">ERROR:</span> ' + evt.data); }
  function writeToScreen(message) {
    var pre = document.createElement("p");
    pre.style.wordWrap = "break-word";
    pre.innerHTML = message;
    output.appendChild(pre);
  }

  function playTrack(srcType, trackId, seconds, meta) {
    document.getElementById('player_info').innerHTML = 
      '<a href="' + meta.url + '">' + meta.title + ' - ' + meta.creator + '</a>';
    switch(srcType) {
      case 'yt':
        player.loadVideoById(trackId, seconds);
        break;
      default:
        break;
    }
  }

  // youtube player
  var tag = document.createElement('script');
  tag.src = "https://www.youtube.com/iframe_api";
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
  function onYouTubeIframeAPIReady() {
    new YT.Player('player', {
      width: 720,
      height:480,
      playerVars: {
        //'controls': 0,    // When a control widget is setup, uncomment
        'disablekb':0,
        'enablejsapi':1,
        'rel':0,
        'modestbranding':1,
        'iv_load_policy':3,
      },
      events: {
        'onReady': onPlayerReady,
        'onStateChange': onPlayerStateChange
      }
    });
  }
  function onPlayerReady(evt) {
    player = evt.target;
  }
  function onPlayerStateChange(evt) {

  }

  function processLogin(evt) {
    evt.preventDefault();
    var user = document.loginForm.user.value;
    var pass = document.loginForm.pass.value;
    userCred = btoa(user + ':' + pass)
    /*$.ajax({
      url:'/auth',
      dataType:'json',
      beforeSend:function(xhr) { xhr.setRequestHeader('Authorization', 'Basic ' + userCred); }
      success:function(model) {
        document.loginForm.display = 'none';
        document.loginControls.display = 'block';
      }
    });*/
    return false;
  }

  window.addEventListener("load", init, false);
</script>

<div class="controls">
<marquee class="player_info" behavior="scroll" direction="left">
<span id="player_info">
</span>
</marquee>
<span id="player_controls">
</span>
<span id="auth_controls">
<form id="loginForm">
    <label>Username:</label><input type="text" name="user" />
    <label>Password:</label><input type="password" name="pass" />
    <input type="submit" value="Login" />
  </form>
</span>
</div>
<div id="player"></div>
<div id="irc">
  <iframe src="https://kiwiirc.com/client/csc.nmu.edu/?nick=radio_user|?&theme=cli#nmu" scrolling="no" id="irc-client"></iframe>
</div>
<div id="output"></div>
</body>
</html>
